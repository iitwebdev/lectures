<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>Python Success Stories</title>
  <meta name="keywords" content="None" />
  <meta name="description" content="None" />
  <link rel="alternate" type="application/rss+xml" title="Community Events"
        href="http://www.python.org/channews.rdf" />
  <link rel="alternate" type="application/rss+xml" title="Python Recipes"
        href="http://aspn.activestate.com/ASPN/Cookbook/Python/index_rss" />
  <link rel="alternate" type="application/rss+xml" title="Usergroup News"
        href="http://python-groups.blogspot.com/feeds/posts/default" />
  <link rel="alternate" type="application/rss+xml" title="Python Screencasts"
        href="http://www.showmedo.com/latestVideoFeed/rss2.0?tag=python" />
  <link rel="alternate" type="application/rss+xml" title="Python Podcasts"
        href="http://www.awaretek.com/python/index.xml" />
  <link rel="alternate" type="application/rss+xml" title="Foundation News"
        href="http://pyfound.blogspot.com/feeds/posts/default" />
  <link rel="alternate" type="application/rss+xml" title="Python Enhancement Proposals"
        href="http://www.python.org/dev/peps/peps.rss" />
  <link rel="stylesheet" type="text/css" media="screen" id="screen-switcher-stylesheet"
        href="/styles/screen-switcher-default.css" />
  <link rel="stylesheet" type="text/css" media="sc&#82;een"
        href="/styles/netscape4.css" />
  <link rel="stylesheet" type="text/css" media="print"
        href="/styles/print.css" />
  <link rel="alternate stylesheet" type="text/css" media="screen"
        href="/styles/largestyles.css" title="large text" />
  <link rel="alternate stylesheet" type="text/css" media="screen"
        href="/styles/defaultfonts.css" title="default fonts" />

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search under the www.python.org Domain"
        href="/search-pysite.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search within the Python Wiki"
        href="/search-pywiki.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search within Python Books at Google Book Search"
        href="/search-pybooks.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search within the Python Documentation"
        href="/search-pydocs.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search for a Module in the Standard Library"
        href="/search-pymodules.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search for Packages inside the Cheeseshop (PyPI)"
        href="/search-pycheese.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search Archives of the Main Python Mailing List"
        href="/search-pythonlist.xml"/>

  <script type="text/javascript" src="/js/iotbs2-key-directors-load.js"></script>
  <script type="text/javascript" src="/js/iotbs2-directors.js"></script>
  <script type="text/javascript" src="/js/iotbs2-core.js"></script>

</head>


<body>
  <!-- Logo -->
  <h1 id="logoheader">
    <a href="/" id="logolink" accesskey="1"><img id="logo" src="/images/python-logo.gif" alt="homepage" border="0" /></a>
  </h1>
  <!-- Skip to Navigation -->
  <div class="skiptonav"><a href="#left-hand-navigation" accesskey="2"><img src="/images/trans.gif" id="skiptonav" alt="skip to navigation" border="0" /></a></div>
  <div class="skiptonav"><a href="#content-body" accesskey="3"><img src="/images/trans.gif" id="skiptocontent" alt="skip to content" border="0" /></a></div>
  <!-- Utility Menu -->
  <div id="utility-menu">
    <!-- Search Box -->
    <div id="searchbox">
      <form method="get" action="http://google.com/search" id="searchform" name="searchform">
        <div id="search">
          <input type="hidden" id="domains" name="domains" value="www.python.org" />
          <input type="hidden" id="sitesearch" name="sitesearch" value="www.python.org" />
          <input type="hidden" id="sourceid" name="sourceid" value="google-search" />
          <input type="text" class="input-text" name="q" id="q" />
          <input type="submit" value="search" class="input-button" name="submit" id="submit" />
          <a href="/search" class="reference">Advanced Search</a>
        </div>
      </form>
    </div>
    <div id="screen-switcher"></div>
  </div>

  <div id="left-hand-navigation">
    <!-- Main Menu -->
    <div id="menu">
      <ul class="level-one">
            <li class="selected">
          <a href="/about/" title="About The Python Language" class="selected">About</a>
	    <ul class="level-two">
		<li>
	      <a href="/about/gettingstarted/">Getting Started</a>
              </li>
		<li>
	      <a href="/about/apps/">Applications</a>
              </li>
		<li class="selected">
	      <a href="/about/success/" class="selected">Success Stories</a>
              </li>
		<li>
	      <a href="/about/quotes/">Quotes</a>
              </li>
		<li>
	      <a href="/about/website/">Website</a>
              </li>
		<li>
	      <a href="/about/help/">Help</a>
              </li>
	    </ul>
        </li>
            <li>
          <a href="/news/" title="Major Happenings Within the Python Community">News</a>
        </li>
            <li>
          <a href="/doc/" title="Tutorials, Library Reference, C API">Documentation</a>
        </li>
            <li>
          <a href="/download/" title="Start Running Python Under Windows, Mac, Linux and Others">Download</a>
        </li>
            <li>
          <a href="/community/" title="Mailing Lists, Jobs, Conferences, SIGs, Online Chats">Community</a>
        </li>
            <li>
          <a href="/psf/" title="Python Software Foundation">Foundation</a>
        </li>
            <li>
          <a href="/dev/" title="Development of the Python language and website">Core Development</a>
        </li>
            <li>
          <a href="/links/" title="Pointers to Useful Information">Links</a>
        </li>
      </ul>
    </div>

    <!-- Quick Links -->
  </div>

  <div id="content-body">
    <div id="body-main">
      <div id="content">
        
          <div id="breadcrumb">
               <a href="/about/">About</a>
               <span class="breadcrumb-separator">&gt;</span>
               <a href="/about/success/">Success Stories</a>
               <span class="breadcrumb-separator">&gt;</span>
            
            Python Success Stories
          </div>



        <!--utf-8--><!--0.4.1--><meta name="author" content="Ned Batchelder" />
<meta name="date" content="2004-06-01" />
<h1 class="title">Cog: A Code Generation Tool Written in Python</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr class="field"><th class="docinfo-name">Category:</th><td class="field-body">Software Development, Business</td>
</tr>
<tr class="field"><th class="docinfo-name">Keywords:</th><td class="field-body">Code Generation, Database, XML, Collaboration Support, Groupware</td>
</tr>
<tr class="field"><th class="docinfo-name">Title:</th><td class="field-body">Cog: A Code Generation Tool Written in Python</td>
</tr>
<tr><th class="docinfo-name">Author:</th>
<td>Ned Batchelder</td></tr>
<tr><th class="docinfo-name">Date:</th>
<td>2004-06-01</td></tr>
<tr class="field"><th class="docinfo-name">Website:</th><td class="field-body"><a class="reference" href="http://www.nedbatchelder.com/">http://www.nedbatchelder.com/</a></td>
</tr>
<tr class="field"><th class="docinfo-name">Website:</th><td class="field-body"><a class="reference" href="http://www.kubisoftware.com/">http://www.kubisoftware.com/</a></td>
</tr>
<tr class="field"><th class="docinfo-name">Summary:</th><td class="field-body">Cog, a general-purpose Python-based code generation tool, is used to speed development of a collaboration system written in C++.</td>
</tr>
<tr class="field"><th class="docinfo-name">Logo:</th><td class="field-body"><div class="first last figure">
<img alt="/files/success/cog/batchelder-logo.gif" src="/files/success/cog/batchelder-logo.gif" />
</div>
</td>
</tr>
</tbody>
</table>
<div class="section">
<h2><a id="introduction" name="introduction">Introduction</a></h2>
<p><a class="reference" href="http://www.nedbatchelder.com/code/cog">Cog</a> is a simple code generation tool written in Python.  We use it or its
results every day in the production of Kubi.</p>
<p><a class="reference" href="http://www.kubisoftware.com/">Kubi</a> is a collaboration system embodied in a handful of different products.
We have a schema that describes the representation of customers'
collaboration data: discussion topics, documents, calendar events, and so on.
This data has to be handled in many ways: stored in a number of different
data stores, shipped over the wire in an XML representation, manipulated in
memory using traditional C++ objects, presented for debugging, and reasoned
about to assess data validity, to name a few.</p>
<p>We needed a way to describe this schema once and then reliably produce
executable code from it.</p>
</div>
<div class="section">
<h2><a id="the-hard-way-with-c" name="the-hard-way-with-c">The Hard Way with C++</a></h2>
<p>Our first implementation of this schema involved a fractured collection of
representations. The XML protocol module had tables describing the
serialization and deserialization of XML streams.  The storage modules had
other tables describing the mapping from disk to memory structures.  The
validation module had its own tables containing rules about which properties
had to be present on which items.  The in-memory objects had getters and
setters for each property.</p>
<p>It worked, after a fashion, but was becoming unmanageable. Adding a new
property to the schema required editing ten tables in different formats in
as many source files, as well as adding getters and setters for the new
property. There was no single authority in the code for the schema as a
whole. Different aspects of the schema were represented in different
ways in different files.</p>
<p>We tried to simplify the mess using C++ macros. This worked to a degree, but
was still difficult to manage. The schema representation was hampered by the
simplistic nature of C++ macros, and the possibilities for expansion were
extremely limited.</p>
<p>The schema tables that could not be created with these primitive macros were
still composed and edited by hand. Changing a property in the schema still
meant touching a dozen files. This was tedious and error prone.  Missing one
place might introduce a bug that would go unnoticed for days.</p>
</div>
<div class="section">
<h2><a id="searching-for-a-better-way" name="searching-for-a-better-way">Searching for a Better Way</a></h2>
<p>It was becoming clear that we needed a better way to manage the property
schema. Not only were the existing modifications difficult, but new areas of
development were going to require new uses of the schema, and new kinds of
modification that would be even more onerous.</p>
<p>We'd been using C++ macros to try to turn a declarative description of the
schema into executable code.  The better way to do it is with code
generation: a program that writes programs.  We could use a tool to read the
schema and generate the C++ code, then compile that generated code into the
product.</p>
<p>We needed a way to read the schema description file and output pieces of code
that could be integrated into our C++ sources to be compiled with the rest of
the product.</p>
<p>Rather than write a program specific to our problem, I chose instead to write
a general-purpose, although simple, code generator tool.  It would solve the
problem of managing small chunks of generator code sprinkled throughout a
large collection of files.  We could then use this general purpose tool to
solve our specific generation problem.</p>
<p>The tool I wrote is called Cog.  Its requirements were:</p>
<ul class="simple">
<li>We needed to be able to perform interesting computation on the schema to
create the code we needed.  Cog would have to provide a powerful language
to write the code generators in.  An existing language would make it easier
for developers to begin using Cog.</li>
<li>I wanted developers to be able to change the schema, and then run the tool
without having to understand the complexities of the code generation. Cog
would have to make it simple to combine the generated chunks of code with
the rest of the C++ source, and it should be simple to run Cog to generate
the final code.</li>
<li>The tool shouldn't care about the language of the host file.  We originally
wanted to generate C++ files, but we were branching out into other
languages. The generation process should be a pure text process, without
regard to the eventual interpretation of that text.</li>
<li>Because the schema would change infrequently, the generation of code should
be an edit-time activity, rather than a build-time activity.  This avoided
having to run the code generator as part of the build, and meant that the
generated code would be available to our IDE and debugger.</li>
</ul>
</div>
<div class="section">
<h2><a id="code-generation-with-python" name="code-generation-with-python">Code Generation with Python</a></h2>
<p>The language I chose for the code generators was, of course, Python. Its
simplicity and power are perfect for the job of reading data files and
producing code. To simplify the integration with the C++ code, the Python
generators are inserted directly into the C++ file as comments.</p>
<p>Cog reads a text file (C++ in our case), looking for specially-marked
sections of text, that it will use as generators.  It executes those sections
as Python code, capturing the output. The output is then spliced into the
file following the generator code.</p>
<p>Because the generator code and its output are both kept in the file, there is
no distinction between the input file and output file.   Cog reads and writes
the same file, and can be run over and over again without losing information.</p>
<div class="figure">
<img alt="Cog's Processing Model" src="/files/success/cog/cog-web.png" />
</div>
<p><em>Cog processes text files, converting specially marked sections of the file
into new content without disturbing the rest of the file or the sections
that it executes to produce the generated content.</em> <a class="reference" href="/files/success/cog/cog.png">Zoom in</a></p>
<p>In addition to executing Python generators, Cog itself is written in Python.
Python's dynamic nature made it simple to execute the Python code Cog found,
and its flexibility made it possible to execute it in a properly-constructed
environment to get the desired semantics. Much of Cog's code is concerned
with getting indentation correct: I wanted the author to be able to organize
his generator code to look good in the host file, and produce generated code
that looked good as well, without worrying about fiddly whitespace issues.</p>
<p>Python's OS-level integration let me execute shell commands where needed. We
use Perforce for source control, which keeps files read-only until they need
to be edited.  When running Cog, it may need to change files that the
developer has not edited yet.  It can execute a shell command to check out
files that are read-only.</p>
<p>Lastly, we used XML for our new property schema description, and Python's
wide variety of XML processing libraries made parsing the XML a snap.</p>
</div>
<div class="section">
<h2><a id="an-example" name="an-example">An Example</a></h2>
<p>Here's a concrete but slightly contrived example.  The properties are
described in an XML file:</p>
<pre class="literal-block">
&lt;!-- Properties.xml --&gt;
&lt;props&gt;
        &lt;property name='Id' type='String' /&gt;
        &lt;property name='RevNum' type='Integer' /&gt;
        &lt;property name='Subject' type='String' /&gt;
        &lt;property name='ModDate' type='Date' /&gt;
&lt;/props&gt;
</pre>
<p>We can write a C++ file with inlined Python code:</p>
<pre class="literal-block">
// SchemaPropEnum.h
enum SchemaPropEnum {
        /* [[[cog
        import cog, handyxml
        for p in handyxml.xpath('Properties.xml', '//property'):
                cog.outl(&quot;Property%s,&quot; % p.name)
        ]]] */
        // [[[end]]]
};
</pre>
<p>After running this file through Cog, it looks like this:</p>
<pre class="literal-block">
// SchemaPropEnum.h
enum SchemaPropEnum {
        /* [[[cog
        import cog, handyxml
        for p in handyxml.xpath('Properties.xml', '//property'):
                cog.outl(&quot;Property%s,&quot; % p.name)
        ]]] */
        PropertyId,
        PropertyRevNum,
        PropertySubject,
        PropertyModDate,
        // [[[end]]]
};
</pre>
<p>The lines with triple-brackets are marker lines that delimit the sections Cog
cares about. The text between the <strong>[[[cog</strong> and <strong>]]]</strong> lines is generator Python
code. The text between <strong>]]]</strong> and <strong>[[[end]]]</strong> is the output from the last run of
Cog (if any). For each chunk of generator code it finds, Cog will:</p>
<blockquote>
<ol class="arabic simple">
<li>discard the output from the last run,</li>
<li>execute the generator code,</li>
<li>capture the output, from the cog.outl calls, and</li>
<li>insert the output back into the output section.</li>
</ol>
</blockquote>
</div>
<div class="section">
<h2><a id="how-it-worked-out" name="how-it-worked-out">How It Worked Out</a></h2>
<p>In a word, great.  We now have a powerful tool that lets us maintain a single
XML file that describes our data schema.  Developers changing the schema have
a simple tool to run that generates code from the schema, producing output
code in four different languages across 50 files.</p>
<p>Where we once used a repetitive and aggravating process that was inadequate
to our needs, we now have an automated process that lets developers express
themselves and have Cog do the hard work.</p>
<p>Python's flexibility and power were put to work in two ways: to develop Cog
itself, and sprinkled throughout our C++ source code to give our developers a
powerful tool to turn static data into running code.</p>
<p>Although our product is built in C++, we've used Python to increase our
productivity and expressive power, ease maintenance work, and automate
error-prone tasks.  Our shipping software is built every day with Python
hard at work behind the scenes.</p>
<p>More information, and Cog itself, is available at
<a class="reference" href="http://www.nedbatchelder.com/code/cog">http://www.nedbatchelder.com/code/cog</a></p>
</div>
<div class="section">
<h2><a id="about-the-author" name="about-the-author">About the Author</a></h2>
<p><em>Ned Batchelder is a professional software developer who struggles along with
C++, using Python to ease the friction every chance he gets. A previous
project of his,</em> <a class="reference" href="/about/success/natsworld">Nat's World *was the subject of an earlier Python Success Story.*</a></p>
</div>


      </div>

      
      <div id="footer">
	<div id="credits">
 	  <a href="/about/website">Website maintained by the Python community</a><br/>
	  <a href="http://www.xs4all.com/" title="Web and email hosting provided by xs4all, Netherlands">hosting by xs4all</a> /
	  <a href="http://www.pollenation.net/" title="Design and content management system by Pollenation Internet, Yorkshire">design by pollenation</a>
	</div>
	Copyright &copy; 1990-2008, <a href='/psf'>Python Software Foundation</a><br/>
	<a href="/about/legal">Legal Statements</a>
      </div>


    </div>
  </div>
</body>
</html>






